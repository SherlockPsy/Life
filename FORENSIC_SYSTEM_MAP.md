# FORENSIC SYSTEM MAP

Generated: 2026-01-01  
Source: Complete codebase inspection  
Status: FACTS ONLY — NO REDESIGN — NO ADVICE

---

## 1) EXECUTIVE OVERVIEW (FACTS ONLY)

### What The System Is

The system is a continuous virtual world expressed through written text, centered on interactions with a character named "Rebecca" (defined as Rebecca Ferguson, the Swedish actress). It operates as an HTTP API server that processes user input and autonomous "beats" through an LLM-powered cognition layer. All events, speech, and actions are recorded to an append-only PostgreSQL ledger (`blocks` table), with semantic search powered by Qdrant vector database. The system enforces strict "written reality" semantics: nothing exists unless recorded as text. Output is generated by DeepSeek LLM (cognition) and optionally rendered through Venice.ai (text rendering). The system explicitly forbids assistant-like behavior, narrative direction, time skips, and hidden state. A "law gate" performs deterministic pattern-matching to reject outputs containing prohibited phrases before they are written.

### Processes That Exist

1. **API Server** — Single Fastify-based HTTP server (`src/server.js:1-455`)
   - No workers, cron jobs, or background schedulers exist in the codebase.
   - No queue consumers exist.

### External Services

1. **PostgreSQL** — Authoritative ledger for all written reality (`src/db.js:1-164`)
2. **Qdrant** — Vector similarity search (`src/qdrant.js:1-70`)
3. **DeepSeek API** — LLM cognition (`src/cognition.js:1-22`)
4. **Venice.ai API** — Embeddings generation and text rendering (`src/embeddings.js:1-29`, `src/renderer.js:1-47`)

### Deployment Assumptions Encoded in Code

- `DATABASE_URL` — PostgreSQL connection string (`src/db.js:6`)
- `QDRANT_URL` — Defaults to `http://qdrant.railway.internal:6333` (`src/qdrant.js:1`)
- `PORT` — Server port, defaults to `3000` (`src/server.js:423`)
- Server binds to `0.0.0.0` (`src/server.js:424`)
- SSL mode for Postgres is conditional: `{ rejectUnauthorized: false }` in production, `false` otherwise (`src/db.js:9`)
- Law files must exist at `./laws/` relative to `process.cwd()` (`src/constraints.js:22-26`)
- `SYSTEM_PROHIBITIONS.md` must exist at boot or process crashes (`src/law/law_gate.js:12-15`)

---

## 2) REPOSITORY STRUCTURE MAP

```
/workspaces/life/
├── package.json                          # Node.js project definition
├── README.md                             # Brief architecture docs
├── DATABASE_DETAILS.md                   # PostgreSQL connection details
├── RAILWAY_INFRASTRUCTURE.md             # Railway deployment documentation
├── NON_NEGOTIABLE_SYSTEM_DECISIONS.md    # Authoritative design decisions (2258 lines)
├── constraints/                          # Prompt constraint files (loaded at startup)
│   ├── 00_KERNEL.md                      # Core output rules
│   ├── 01_NO_ASSISTANT.md                # Anti-assistant language rules
│   ├── 01_REBECCA_MICRO.md               # Rebecca mug boundary rule
│   ├── 02_IN_WORLD_OUTPUT.md             # In-world output rules
│   ├── 02_REBECCA_TRIGGERS_COFFEE.md     # Rebecca cold coffee rule
│   ├── 03_NO_CONCIERGE_TONE.md           # Banned customer-service phrases
│   ├── 04_NO_THERAPISTY_VALIDATION.md    # Banned validation phrases
│   └── SYSTEM_PROHIBITIONS.md            # Duplicate of laws/SYSTEM_PROHIBITIONS.md
├── laws/                                 # Authoritative law documents (loaded at boot)
│   ├── MASTER_CONSTITUTION.md            # Reality/ontology rules (290 lines)
│   ├── MASTER_RUNTIME.md                 # Runtime invocation rules (377 lines)
│   ├── MASTER_INFRASTRUCTURE.md          # Storage/DB rules (444 lines)
│   ├── MASTER_WORLD.md                   # World/scene/time rules (403 lines)
│   └── SYSTEM_PROHIBITIONS.md            # Forbidden patterns list (242 lines)
└── src/                                  # Application source code
    ├── server.js                         # Main entrypoint, HTTP routes (455 lines)
    ├── cognition.js                      # DeepSeek LLM invocation (22 lines)
    ├── constraints.js                    # Law file loader (55 lines)
    ├── db.js                             # PostgreSQL operations (164 lines)
    ├── embeddings.js                     # Venice embeddings API (29 lines)
    ├── qdrant.js                         # Qdrant vector DB operations (70 lines)
    ├── renderer.js                       # Venice text rendering (47 lines)
    ├── cache/
    │   └── scene_cache.ts                # In-memory cache (TypeScript, unused)
    └── law/
        ├── law_gate.js                   # Deterministic prohibition enforcement (71 lines)
        └── laws.js                       # TypeScript law loader (unused at runtime)
```

### Directory Usage

- **`/constraints/`** — UNKNOWN FROM CODE: These files are NOT loaded by the codebase. The README claims `constraints/00_KERNEL.md` and `constraints/01_REBECCA_MICRO.md` are loaded, but `src/constraints.js:20-47` only reads from `laws/` directory.
- **`/laws/`** — Authoritative law documents loaded at boot by `src/constraints.js:22-46`. All five `.md` files are required.
- **`/src/`** — Runtime JavaScript application code.
- **`/src/cache/`** — Contains `scene_cache.ts` (TypeScript). UNKNOWN FROM CODE: This file is NOT imported by any `.js` file. It defines an in-memory Map-based cache but appears unused.
- **`/src/law/`** — Law enforcement code. `law_gate.js` is actively used. `laws.js` is TypeScript and NOT imported by any runtime code.

### Entrypoint Files

- **`src/server.js`** — Sole runtime entrypoint. Started via `node src/server.js` (package.json:6)

---

## 3) RUNTIME COMPONENTS AND ENTRYPOINTS

### Component: API Server

**Entrypoint**: `src/server.js:1-455`  
**Start Command**: `node src/server.js` (defined in `package.json:6`)

#### Startup Lifecycle (`src/server.js:405-432`)

1. **Load Constraints** (`src/server.js:408`)
   - Calls `loadConstraints()` from `src/constraints.js`
   - Reads all 5 files from `laws/` directory
   - If ANY file is missing or empty, process crashes with `Error: LAW FILE MISSING` or `LAW FILE EMPTY`
   - Returns combined string with section headers

2. **Set Renderer Constraints** (`src/server.js:409`)
   - Passes combined constraints string to `setRendererConstraints()` in `src/renderer.js:5-7`
   - Stored in module-level variable `rendererConstraints`

3. **Ping Database** (`src/server.js:412-418`)
   - Calls `pingDb()` which executes `SELECT 1`
   - On success: sets `dbAvailable = true`
   - On failure: sets `dbAvailable = false`, logs error, continues

4. **Ensure Qdrant Collection** (`src/server.js:421`)
   - Calls `ensureCollection()` from `src/qdrant.js:22-40`
   - Checks if collection `blocks` exists
   - Creates if missing with vector size from `EMBEDDINGS_DIM` (default 1024), Cosine distance
   - On any error: sets `qdrantAvailable = false`, continues without crash

5. **Start HTTP Server** (`src/server.js:423-426`)
   - Binds to `0.0.0.0:${PORT}` (PORT defaults to 3000)
   - Uses Fastify with `{ logger: true }`

6. **On Fatal Error** (`src/server.js:427-430`)
   - Logs error and calls `process.exit(1)`

#### Request Handling

Requests are handled synchronously. No background loops, timers, or recurring tasks exist in the codebase.

#### Shutdown

No explicit shutdown handlers (`SIGTERM`, `SIGINT`) are defined. Process terminates on crash or kill signal.

---

## 4) API SURFACE

### Route: `GET /`

**Handler**: `src/server.js:110-113`  
**Purpose**: Serves embedded HTML UI  
**Response**: HTML string (`UI_HTML` defined at `src/server.js:24-107`)  
**Content-Type**: `text/html; charset=utf-8`

---

### Route: `GET /health`

**Handler**: `src/server.js:223-225`  
**Purpose**: Health check  
**Response Schema**:
```json
{
  "status": "ok",
  "timestamp": "2026-01-01T00:00:00.000Z"
}
```
**Authentication**: None  
**Idempotency**: N/A (read-only)

---

### Route: `POST /say`

**Handler**: `src/server.js:228-307`  
**Purpose**: Process user input, generate response, write to ledger

#### Request Schema

**Headers**: `Content-Type: application/json`  
**Body**:
```json
{
  "text": "string",        // User's input text
  "request_id": "string"   // Optional, generated if missing
}
```

#### Processing Flow

1. **DB Availability Check** (`src/server.js:229-232`)
   - Returns `503 { error: "db_unavailable" }` if `dbAvailable === false`

2. **Idempotency Check** (`src/server.js:237-240`)
   - Calls `getRequestLog(requestId)` from `src/db.js:60-71`
   - If exists, returns cached response immediately

3. **Context Retrieval** (`src/server.js:243`)
   - Calls `retrieveContext(text)` from `src/server.js:151-177`
   - Generates embedding via Venice API
   - Searches Qdrant for 12 similar vectors
   - Fetches matched blocks from Postgres by ID
   - Fetches 8 most recent blocks from Postgres
   - Merges and dedupes by ID
   - On error: falls back to recent blocks only

4. **Scene Package Retrieval** (`src/server.js:244`)
   - Calls `getScenePackage()` from `src/db.js:92-130`
   - Tries cache table first, rebuilds from ledger if missing

5. **System Prompt Assembly** (`src/server.js:247-251`)
   - Calls `buildSystemPrompt()` from `src/server.js:117-148`
   - Concatenates: constraints + scene + memory + output format

6. **LLM Cognition** (`src/server.js:253`)
   - Calls `runCognition(systemPrompt, userPrompt)` from `src/cognition.js:9-21`
   - Uses DeepSeek API with `model: 'deepseek-chat'`, `temperature: 0.7`, `response_format: { type: 'json_object' }`

7. **Response Validation** (`src/server.js:256-261`)
   - If `cognitionResult.wrote === true`, requires `speaker` and `outward_text`
   - Returns `500 { error: "invalid_cognition_json" }` if missing

8. **Law Gate Validation** (`src/server.js:264-279`)
   - Calls `lawGateValidateTextParts()` from `src/law/law_gate.js:59-71`
   - Validates: `outward_text`, all block texts, `scene_update`
   - If `gate.ok === false`: returns `{ wrote: false, speaker: "", text: "", scene_refreshed: false }`

9. **Write Blocks** (`src/server.js:282-284`)
   - If `public_blocks` or `blocks_to_write` exist in cognition result
   - Calls `writeBlocks()` from `src/server.js:180-219`
   - Inserts each block to Postgres with generated UUID
   - Generates embedding and upserts to Qdrant

10. **Scene Update** (`src/server.js:287-291`)
    - If `cognitionResult.scene_update` exists
    - Calls `updateScenePackage()` from `src/db.js:132-148`
    - Writes to ledger as `SYSTEM` block with `visibility: private`

11. **Text Rendering** (`src/server.js:294-296`)
    - If `cognitionResult.wrote === true`
    - Calls `renderText()` from `src/renderer.js:9-47`
    - Uses Venice API with constraints in system prompt

12. **Log for Idempotency** (`src/server.js:305`)
    - Calls `insertRequestLog()` which upserts to `request_log` table

#### Response Schema

```json
{
  "request_id": "string",
  "wrote": true,
  "speaker": "REBECCA",
  "text": "Rendered output text",
  "scene_refreshed": false
}
```

#### Error Cases

| Code | Body | Condition |
|------|------|-----------|
| 503 | `{ error: "db_unavailable" }` | Database not connected |
| 500 | `{ error: "invalid_cognition_json" }` | LLM returned invalid structure |
| 500 | `{ error: "<message>" }` | Any unhandled exception |

---

### Route: `POST /beat`

**Handler**: `src/server.js:310-402`  
**Purpose**: Autonomous tick (no user input)

#### Request Schema

**Headers**: `Content-Type: application/json`  
**Body**:
```json
{
  "request_id": "string"   // Optional
}
```

#### Processing Flow

Identical to `/say` except:
- User prompt is: `Autonomous beat tick. Current scene: ${scenePackage || "none"}. Process any pending thoughts or observations.` (`src/server.js:343-345`)
- Query text for retrieval: `BEAT ${scenePackage || "idle state"}` (`src/server.js:332`)

#### Response Schema

Same as `/say`.

---

### Authentication/Authorization

None implemented. All endpoints are publicly accessible.

---

### Idempotency Behavior

Both `/say` and `/beat` implement idempotency via `request_id`:
- If `request_id` exists in `request_log` table, cached response is returned immediately (`src/server.js:237-240`, `src/server.js:323-326`)
- Implemented via `ON CONFLICT DO UPDATE` in PostgreSQL (`src/db.js:75-82`)

---

## 5) DATA MODEL (DATABASE)

### Technology

PostgreSQL 17.7 (confirmed via Railway deployment)

### Connection

- Connection string from `DATABASE_URL` environment variable (`src/db.js:6`)
- Uses `pg` package `Pool` (`src/db.js:3-10`)
- SSL: `{ rejectUnauthorized: false }` if `NODE_ENV === "production"`, otherwise `false` (`src/db.js:9`)

---

### Table: `blocks`

**Purpose**: Append-only ledger of all written reality  
**Schema** (from code `src/db.js:22-27` and database inspection):

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NOT NULL | `gen_random_uuid()` | Primary key |
| `ts` | TIMESTAMPTZ | NOT NULL | `now()` | Timestamp of creation |
| `source` | TEXT | NOT NULL | — | Author attribution (e.g., "REBECCA", "SYSTEM", "OTHER") |
| `text` | TEXT | NOT NULL | — | The written content |
| `visibility` | TEXT | NOT NULL | `'public'` | Access classification ("public", "private") |
| `request_id` | TEXT | NULL | — | Reference to originating request |
| `embedding` | DOUBLE PRECISION[] | NULL | — | Vector embedding (UNKNOWN FROM CODE: not written by application) |

**Indexes**:
- `blocks_pkey` — PRIMARY KEY on `id`
- `idx_blocks_ts_desc` — B-tree on `ts DESC`

**Constraints**: None beyond PRIMARY KEY

**Migrations**: UNKNOWN FROM CODE — No migration files exist in repository

#### Write Paths

1. **`insertBlock()`** (`src/db.js:18-30`)
   - Called from `writeBlocks()` (`src/server.js:180-219`)
   - Called from `updateScenePackage()` (`src/db.js:132-148`)
   - Inserts: `id`, `source`, `text`, `visibility`, `request_id`
   - Does NOT insert `embedding` column (discrepancy with schema)

2. **Scene Package Updates** (`src/db.js:137-147`)
   - Source: `SYSTEM`
   - Visibility: `private`
   - Text format: `SCENE_PACKAGE:\n${sceneText}`

#### Read Paths

1. **`getBlocksByIds(ids)`** (`src/db.js:32-45`)
   - Used after Qdrant similarity search
   - Returns: `id`, `source`, `text`, `visibility`, `ts`
   - Ordered by `ts ASC`

2. **`getRecentBlocks(limit)`** (`src/db.js:47-58`)
   - Returns most recent blocks (default 8)
   - Ordered by `ts DESC`, then reversed to oldest-first

3. **`rebuildScenePackageFromLedger()`** (`src/db.js:102-117`)
   - Finds latest `SYSTEM`/`private` block starting with `SCENE_PACKAGE:`
   - Ordered by `ts DESC`, limit 1

---

### Table: `request_log`

**Purpose**: Idempotency tracking  
**Schema** (from code `src/db.js:60-82` and database inspection):

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `request_id` | TEXT | NOT NULL | — | Primary key |
| `response` | JSONB | NOT NULL | — | Cached response object |
| `created_at` | TIMESTAMPTZ | NOT NULL | `now()` | Timestamp |

**Indexes**:
- `request_log_pkey` — PRIMARY KEY on `request_id`

#### Write Paths

1. **`insertRequestLog(requestId, responseObj)`** (`src/db.js:73-82`)
   - Uses `ON CONFLICT (request_id) DO UPDATE`
   - Called at end of `/say` and `/beat` handlers

#### Read Paths

1. **`getRequestLog(requestId)`** (`src/db.js:62-71`)
   - Returns `response` column as JSON
   - Returns `null` if not found

---

### Table: `scene_cache`

**Purpose**: Convenience cache for scene package (explicitly non-authoritative per `src/db.js:83-91`)  
**Schema** (from code and database inspection):

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | INTEGER | NOT NULL | — | Primary key (always 1) |
| `scene_package` | TEXT | NOT NULL | `''` | Cached scene text |
| `updated_at` | TIMESTAMPTZ | NOT NULL | `now()` | Last update timestamp |

**Indexes**:
- `scene_cache_pkey` — PRIMARY KEY on `id`

#### Write Paths

1. **`setScenePackageCache(sceneText)`** (`src/db.js:96-103`)
   - Upserts row with `id = 1`
   - Called after rebuilding from ledger or after scene update

#### Read Paths

1. **`getScenePackageFromCache()`** (`src/db.js:92-98`)
   - Reads row with `id = 1`
   - Returns `scene_package` or `null`

---

## 6) DATA MODEL (NON-DB STATE)

### Qdrant Vector Store

**Technology**: Qdrant 1.16.3  
**Collection**: `blocks`  
**Configuration** (`src/qdrant.js:1-3`):
- URL: `QDRANT_URL` env var, defaults to `http://qdrant.railway.internal:6333`
- Vector size: `EMBEDDINGS_DIM` env var, defaults to `1024`
- Distance metric: `Cosine` (hardcoded in `src/qdrant.js:33`)

**Point Structure** (`src/qdrant.js:44-53`):
```json
{
  "id": "uuid-string",
  "vector": [float...],
  "payload": {
    "source": "string",
    "visibility": "string",
    "ts": "ISO8601 timestamp"
  }
}
```

**Write Path**: `upsertPoint(id, vector, payload)` (`src/qdrant.js:44-57`)  
**Read Path**: `searchSimilar(vector, topK)` (`src/qdrant.js:59-70`)

---

### Module-Level Variables

1. **`src/server.js:20-21`**
   - `CONSTRAINTS` — Combined law text, set once at startup
   - `dbAvailable` — Boolean, set at startup based on DB ping

2. **`src/qdrant.js:4`**
   - `qdrantAvailable` — Boolean, set to `false` on Qdrant errors

3. **`src/renderer.js:4`**
   - `rendererConstraints` — String, set at startup via `setRendererConstraints()`

---

### Filesystem Persistence

Law files are read from filesystem at boot:
- `laws/MASTER_CONSTITUTION.md`
- `laws/MASTER_RUNTIME.md`
- `laws/MASTER_INFRASTRUCTURE.md`
- `laws/MASTER_WORLD.md`
- `laws/SYSTEM_PROHIBITIONS.md`

---

### In-Memory Cache (UNUSED)

`src/cache/scene_cache.ts` defines a `Map<string, CacheEntry>` but is TypeScript and NOT imported by any runtime code.

---

## 7) EVENT / JOB / QUEUE FLOWS

No queue technology is used.  
No job processors exist.  
No event bus exists.  
No pub/sub exists.

All processing is synchronous HTTP request/response.

---

## 8) LLM / AI INTEGRATIONS

### DeepSeek (Cognition)

**File**: `src/cognition.js:1-22`  
**Client**: OpenAI SDK pointed at DeepSeek  
**Configuration** (`src/cognition.js:3-6`):
- `apiKey`: `DEEPSEEK_API_KEY`
- `baseURL`: `https://api.deepseek.com` (hardcoded)

**Model Parameters** (`src/cognition.js:12-16`):
- `model`: `deepseek-chat` (hardcoded)
- `temperature`: `0.7`
- `response_format`: `{ type: 'json_object' }`

**Prompt Structure**:
- System message: Combined constraints + scene + memory + output format
- User message: `User says: ${text}` or autonomous beat prompt

**System Prompt Assembly** (`src/server.js:117-148`):
```
=== MASTER_CONSTITUTION ===
<full file content>

=== MASTER_RUNTIME ===
<full file content>

=== MASTER_INFRASTRUCTURE ===
<full file content>

=== MASTER_WORLD ===
<full file content>

=== SYSTEM_PROHIBITIONS ===
<full file content>

SCENE:
<scene package if exists>

MEMORY:
[timestamp] source: text (visibility)
[timestamp] source: text (visibility)
...

OUTPUT FORMAT (strict JSON):
{
  "speaker": "REBECCA",
  "outward_text": "string",
  "public_blocks": [{ "source": "REBECCA|SYSTEM|OTHER", "text": "...", "visibility": "public" }],
  "scene_update": "string|null",
  "wrote": true|false,
  "scene_refreshed": false
}
```

**Response Parsing** (`src/cognition.js:19-21`):
- Raw `content` string parsed via `JSON.parse()`
- No error handling for malformed JSON (will throw)

---

### Venice.ai (Embeddings)

**File**: `src/embeddings.js:1-29`  
**Configuration** (`src/embeddings.js:1-4`):
- `VENICE_BASE_URL`: defaults to `https://api.venice.ai/api/v1`
- `EMBEDDINGS_BASE_URL`: defaults to `VENICE_BASE_URL`
- `EMBEDDINGS_API_KEY`: defaults to `VENICE_API_KEY`
- `EMBEDDINGS_MODEL`: defaults to `text-embedding-bge-m3`

**API Call** (`src/embeddings.js:6-27`):
- Endpoint: `${EMBEDDINGS_BASE_URL}/embeddings`
- Method: POST
- Body: `{ model, input: text, encoding_format: 'float' }`
- Returns: `data.data[0].embedding` (float array)

---

### Venice.ai (Rendering)

**File**: `src/renderer.js:1-47`  
**Configuration** (`src/renderer.js:1-2`):
- `VENICE_API_KEY`: required
- `VENICE_MODEL`: defaults to `llama-3.3-70b`

**Prompt Template** (`src/renderer.js:17-19`):
```
System: <rendererConstraints>

Render the following as natural speech. Output ONLY the rendered text.

User: <outwardText>
```

**Model Parameters** (`src/renderer.js:21-38`):
- `model`: `VENICE_MODEL`
- `temperature`: `0.5`
- Endpoint: `https://api.venice.ai/api/v1/chat/completions` (hardcoded)

---

### Guardrails / Prohibitions Enforcement

**File**: `src/law/law_gate.js:1-71`

#### Initialization (`src/law/law_gate.js:12-17`)
- Reads `laws/SYSTEM_PROHIBITIONS.md` at module load
- Throws if file missing

#### Forbidden Patterns (`src/law/law_gate.js:22-51`)
Hardcoded regex list:
```javascript
const FORBIDDEN_PATTERNS = [
  /\blater that day\b/i,
  /\bafter a while\b/i,
  /\bhours passed\b/i,
  /\bthe next (day|morning|week|month)\b/i,
  /\beventually\b/i,
  /\bmust have happened\b/i,
  /\bprobably happened\b/i,
  /\bwe can assume\b/i,
  /\bclearly\b/i,
  /\bobviously\b/i,
  /\bmeanwhile\b/i,
  /\bin the background\b/i,
  /\bunseen\b/i,
  /\boff-screen\b/i,
  /\bas an ai\b/i,
  /\bas a language model\b/i,
  /\bsystem prompt\b/i,
  /\bruntime\b/i,
  /\bpolicy\b/i,
  /\bguidelines\b/i,
  /\bthis leads to\b/i,
  /\bsetting the stage\b/i,
  /\bthe scene shifts\b/i,
];
```

#### Validation Function (`src/law/law_gate.js:59-71`)
- Joins all text parts with `\n\n`
- Normalizes to lowercase
- Tests each regex
- Returns `{ ok: false, reason: "LAW_VIOLATION:<pattern>" }` on first match
- Returns `{ ok: true }` if all pass

#### Call Site (`src/server.js:264-279`, `src/server.js:350-365`)
- Called BEFORE writing blocks, scene updates, or rendering
- If `gate.ok === false`: response is `{ wrote: false, speaker: "", text: "" }`

---

## 9) "WORLD ENGINE" LOGIC (AS IMPLEMENTED)

### Core Concept

There is no "world engine" as a separate module. The cognition loop IS the world engine:
1. User or beat triggers invocation
2. Context is assembled from ledger + vector search
3. LLM generates response with blocks/scene updates
4. Law gate validates
5. Valid content is written to ledger

### Representation of Concepts

#### Time
- No explicit time module exists
- Timestamp is `now()` from PostgreSQL (`src/db.js:26`)
- Time displayed in memory as `[${b.ts}]` in prompt (`src/server.js:120`)
- No clock advancement mechanism exists

#### Scene
- Stored as text in `scene_cache.scene_package` (convenience) and in `blocks` table as `SCENE_PACKAGE:` prefixed entries (authoritative)
- Retrieved via `getScenePackage()` (`src/db.js:119-130`)
- Updated via `updateScenePackage()` (`src/db.js:132-148`)
- Always total replacement, never partial

#### Memory
- All blocks in `blocks` table
- Retrieved via semantic search (Qdrant) + recent blocks (Postgres)
- Formatted as `[timestamp] source: text (visibility)` (`src/server.js:119-121`)

#### Ledger/Blocks
- Append-only PostgreSQL table
- Each block has: id, ts, source, text, visibility, request_id

### Algorithmic Steps for One "Tick"

**For `/say`** (`src/server.js:228-307`):

1. Receive `{ text, request_id }`
2. Check idempotency → return cached if exists
3. Generate embedding for `text`
4. Search Qdrant for top 12 similar
5. Fetch matched blocks from Postgres
6. Fetch 8 recent blocks from Postgres
7. Merge and dedupe blocks
8. Fetch scene package (cache → ledger fallback)
9. Assemble system prompt: laws + scene + memory + format
10. Call DeepSeek with system + user prompt
11. Parse JSON response
12. Validate structure (speaker, outward_text if wrote=true)
13. Law gate validate (outward_text, blocks, scene_update)
14. If gate fails: return empty response
15. For each block in response: insert to Postgres, generate embedding, upsert to Qdrant
16. If scene_update: write to ledger and cache
17. If wrote: render via Venice
18. Log response for idempotency
19. Return response

**For `/beat`** (`src/server.js:310-402`):

Same as above except:
- No user text input
- Query for embeddings: `BEAT ${scenePackage || "idle state"}`
- User prompt: `Autonomous beat tick. Current scene: ...`

### Determinism vs Randomness

- **Deterministic**: Law gate regex matching, database operations, idempotency checks
- **Non-deterministic**: LLM outputs (temperature 0.7 for cognition, 0.5 for rendering), vector search results

---

## 10) CONFIGURATION AND ENVIRONMENT

### Environment Variables Referenced

| Variable | File:Line | Purpose | Default |
|----------|-----------|---------|---------|
| `DATABASE_URL` | `src/db.js:6` | PostgreSQL connection string | None (required) |
| `NODE_ENV` | `src/db.js:9` | Controls SSL mode | None |
| `QDRANT_URL` | `src/qdrant.js:1` | Qdrant HTTP endpoint | `http://qdrant.railway.internal:6333` |
| `EMBEDDINGS_DIM` | `src/qdrant.js:3` | Vector dimension size | `1024` |
| `VENICE_BASE_URL` | `src/embeddings.js:1` | Venice API base URL | `https://api.venice.ai/api/v1` |
| `EMBEDDINGS_BASE_URL` | `src/embeddings.js:2` | Embeddings API URL | `VENICE_BASE_URL` |
| `EMBEDDINGS_API_KEY` | `src/embeddings.js:3` | Embeddings auth token | `VENICE_API_KEY` |
| `VENICE_API_KEY` | `src/embeddings.js:3`, `src/renderer.js:1` | Venice auth token | None (required for rendering) |
| `EMBEDDINGS_MODEL` | `src/embeddings.js:4` | Embeddings model name | `text-embedding-bge-m3` |
| `VENICE_MODEL` | `src/renderer.js:2` | Rendering LLM model | `llama-3.3-70b` |
| `DEEPSEEK_API_KEY` | `src/cognition.js:4` | DeepSeek auth token | None (required) |
| `PORT` | `src/server.js:423` | HTTP server port | `3000` |

### Config Files

- **`package.json`** — Node.js project definition, start script
- **`laws/*.md`** — Law documents (required at boot)
- **`constraints/*.md`** — UNUSED in actual code despite README claims

### Feature Flags / Mode Switches

None exist.

### Dev vs Prod Differences

- SSL mode for Postgres: `{ rejectUnauthorized: false }` if `NODE_ENV === "production"`, otherwise `false` (`src/db.js:9`)
- No other conditional behavior based on environment

---

## 11) OBSERVABILITY

### Logging

**Framework**: Fastify built-in logger (`src/server.js:19`)
```javascript
const app = Fastify({ logger: true });
```

**Log Outputs**:
- Request/response logging via Fastify
- `console.log` for startup messages (`src/server.js:413`, `src/server.js:426`, `src/qdrant.js:27`, `src/qdrant.js:36`)
- `console.error` for errors (`src/server.js:306`, `src/server.js:398`, `src/qdrant.js:38`, `src/qdrant.js:56`, `src/qdrant.js:68`, `src/server.js:153`, `src/server.js:218`)

### Metrics / Tracing

None implemented.

### Error Reporting

Errors logged to console only. No external error reporting service integration.

### Health Checks

Single endpoint: `GET /health` (`src/server.js:223-225`)
- Returns `{ status: "ok", timestamp: "..." }`
- Does NOT verify database connectivity
- Does NOT verify Qdrant connectivity
- Does NOT verify external API connectivity

---

## 12) SECURITY AND ACCESS

### Secrets Handling

All secrets passed via environment variables:
- `DATABASE_URL` (contains password)
- `DEEPSEEK_API_KEY`
- `VENICE_API_KEY`
- `EMBEDDINGS_API_KEY`

Secrets are read at module load time and stored in memory.

### Auth Checks

None. All endpoints are publicly accessible.

### Exposed Admin/Debug Endpoints

None exist. The embedded UI at `/` is the only non-API endpoint.

---

## 13) TESTS

### Test Frameworks

None installed. No test files exist.

### Test Coverage

Zero.

### How to Run Tests

No test command defined in `package.json`.

---

## 14) RUN INSTRUCTIONS (AS IMPLEMENTED)

### Start Command

From `package.json:6`:
```bash
npm start
```

Which executes:
```bash
node src/server.js
```

### Required Environment Variables to Start Without Crashing

1. **Required for boot (will crash if missing)**:
   - Law files must exist at `laws/MASTER_CONSTITUTION.md`, `laws/MASTER_RUNTIME.md`, `laws/MASTER_INFRASTRUCTURE.md`, `laws/MASTER_WORLD.md`, `laws/SYSTEM_PROHIBITIONS.md`
   - `laws/SYSTEM_PROHIBITIONS.md` also read by `src/law/law_gate.js` at module load

2. **Required for database operations**:
   - `DATABASE_URL` — If missing, `pingDb()` will fail but server continues with `dbAvailable = false`

3. **Required for LLM calls (will error on request)**:
   - `DEEPSEEK_API_KEY` — Required for cognition
   - `VENICE_API_KEY` — Required for rendering and embeddings (if `EMBEDDINGS_API_KEY` not set)

4. **Optional with defaults**:
   - `PORT` — defaults to `3000`
   - `QDRANT_URL` — defaults to `http://qdrant.railway.internal:6333`
   - `EMBEDDINGS_DIM` — defaults to `1024`
   - `EMBEDDINGS_MODEL` — defaults to `text-embedding-bge-m3`
   - `VENICE_MODEL` — defaults to `llama-3.3-70b`
   - `VENICE_BASE_URL` — defaults to `https://api.venice.ai/api/v1`

### Local Development

```bash
# Install dependencies
npm install

# Set required environment variables
export DATABASE_URL="postgresql://user:pass@localhost:5432/life"
export DEEPSEEK_API_KEY="sk-..."
export VENICE_API_KEY="..."

# Start server
npm start

# Server available at http://localhost:3000
```

### Dependencies

From `package.json:9-14`:
```json
{
  "fastify": "^4.26.0",
  "openai": "^4.20.0",
  "pg": "^8.11.3",
  "uuid": "^9.0.0"
}
```

---

## APPENDIX A: CONSTRAINT FILE LOADING DISCREPANCY

**README.md claims** (`README.md:75`):
> `constraints/00_KERNEL.md` and `constraints/01_REBECCA_MICRO.md` are loaded at startup.

**Actual code** (`src/constraints.js:20-47`):
- Only reads from `laws/` directory
- Does NOT read from `constraints/` directory
- The `constraints/` directory files are NOT used at runtime

This is a documentation/code mismatch.

---

## APPENDIX B: TYPESCRIPT FILES

Two TypeScript files exist but are NOT used at runtime:

1. `src/cache/scene_cache.ts` — In-memory cache implementation
2. `src/law/laws.js` — TypeScript law loader (extension says `.js` but content is TypeScript)

The `package.json` has no TypeScript compilation configured. No `tsconfig.json` exists. These files are dead code.

---

## APPENDIX C: COMPLETE FORBIDDEN PATTERN LIST

From `src/law/law_gate.js:22-51`:

| Pattern | Category |
|---------|----------|
| `/\blater that day\b/i` | Time jumps |
| `/\bafter a while\b/i` | Time jumps |
| `/\bhours passed\b/i` | Time jumps |
| `/\bthe next (day\|morning\|week\|month)\b/i` | Time jumps |
| `/\beventually\b/i` | Time jumps |
| `/\bmust have happened\b/i` | Retroactive invention |
| `/\bprobably happened\b/i` | Retroactive invention |
| `/\bwe can assume\b/i` | Retroactive invention |
| `/\bclearly\b/i` | Retroactive invention |
| `/\bobviously\b/i` | Retroactive invention |
| `/\bmeanwhile\b/i` | Hidden state |
| `/\bin the background\b/i` | Hidden state |
| `/\bunseen\b/i` | Hidden state |
| `/\boff-screen\b/i` | Hidden state |
| `/\bas an ai\b/i` | Meta/system leakage |
| `/\bas a language model\b/i` | Meta/system leakage |
| `/\bsystem prompt\b/i` | Meta/system leakage |
| `/\bruntime\b/i` | Meta/system leakage |
| `/\bpolicy\b/i` | Meta/system leakage |
| `/\bguidelines\b/i` | Meta/system leakage |
| `/\bthis leads to\b/i` | Narrative steering |
| `/\bsetting the stage\b/i` | Narrative steering |
| `/\bthe scene shifts\b/i` | Narrative steering |

---

END OF FORENSIC SYSTEM MAP
